<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
  <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
  <!-- Topbar -->
  <header class="admin-topbar">
    <div class="admin-topbar__container">
      <div class="admin-topbar__left">
        <span class="material-icons admin-topbar__logo" aria-hidden="true">event</span>
        <span class="admin-topbar__title">Schedule Manager</span>
      </div>
      <div class="admin-topbar__right">
        <button class="admin-topbar__icon-btn" type="button" aria-label="Notifications" id="adminNotifBtn">
          <span class="material-icons" aria-hidden="true">notifications</span>
          {% if pending_swaps and pending_swaps > 0 %}
            <span class="notif-badge">{{ pending_swaps }}</span>
          {% else %}
            <span class="notif-badge">1</span>
          {% endif %}
        </button>
        <div class="admin-topbar__user" aria-label="Current user">
          <span class="material-icons" aria-hidden="true">person</span>
          <span class="admin-topbar__name">{{ user.full_name if user else 'Admin User' }}</span>
        </div>
        <span class="role-chip role-chip--admin">System Admin</span>
        <form method="POST" action="{{ url_for('auth.logout') }}" class="logout-form" style="display: inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <button type="submit" class="logout-btn">
            <span class="material-icons" aria-hidden="true">logout</span>
            <span>Logout</span>
          </button>
        </form>
      </div>
    </div>
  </header>

  <!-- You can add admin content below -->
  <main class="container" style="max-width:1200px;margin:24px auto;padding:0 16px;">
    <h2 style="font-family: 'Roboto', sans-serif; font-weight: 600;">Admin Dashboard</h2>
    
    <!-- Navigation Tabs -->
    <nav class="admin-nav-tabs">
      <button class="admin-tab active" data-tab="dashboard">
        <span class="material-icons">bar_chart</span>
        <span>Dashboard</span>
      </button>
      <button class="admin-tab" data-tab="schedule">
        <span class="material-icons">event</span>
        <span>Schedule</span>
      </button>
      <button class="admin-tab" data-tab="employees">
        <span class="material-icons">group</span>
        <span>Employees</span>
      </button>
      <button class="admin-tab" data-tab="session-swaps">
        <span class="material-icons">swap_horiz</span>
        <span>Session Swaps</span>
        <span class="tab-badge">3</span>
      </button>
    </nav>

    <!-- Welcome Banner -->
    <div class="admin-welcome-banner">
      <div class="admin-welcome-content">
        <h1 class="admin-welcome-greeting">Good afternoon, {{ user.first_name if user else 'Admin' }}! ðŸ‘‹</h1>
        <p class="admin-welcome-role">System Administrator â€¢ Schedule Manager</p>
        <p class="admin-welcome-stats">System-wide: 47 units, 12 coordinators, 125 facilitators across all programs.</p>
      </div>
      <div class="admin-welcome-actions">
        <button class="admin-settings-btn" type="button" aria-label="Settings">
          <span class="material-icons">settings</span>
        </button>
      </div>
    </div>


    <!-- Unit Status Distribution -->
    <div class="unit-status-card">
      <h3 class="unit-status-title">Unit Status Distribution</h3>
      
      <!-- Top Row - Unit Status -->
      <div class="unit-status-row">
        <div class="unit-status-metric">
          <div class="unit-status-value active">{{ active_units_count or 28 }}</div>
          <div class="unit-status-label">Active Units</div>
        </div>
        <div class="unit-status-metric">
          <div class="unit-status-value upcoming">{{ upcoming_units_count or 12 }}</div>
          <div class="unit-status-label">Upcoming Units</div>
        </div>
        <div class="unit-status-metric">
          <div class="unit-status-value completed">{{ completed_units_count or 7 }}</div>
          <div class="unit-status-label">Completed Units</div>
        </div>
      </div>

      <!-- Bottom Row - Session Statistics -->
      <div class="session-stats-row">
        <div class="session-stat-metric">
          <div class="session-stat-value">{{ avg_sessions_per_unit or 8.3 }}</div>
          <div class="session-stat-label">Average Sessions per Unit</div>
        </div>
        <div class="session-stat-metric">
          <div class="session-stat-value">{{ total_sessions_completed or 1847 }}</div>
          <div class="session-stat-label">Total Sessions Completed</div>
        </div>
      </div>
    </div>

    <!-- Facilitator Management Section (Hidden by default) -->
    <div class="facilitator-management" id="facilitatorManagement" style="display: none;">
      <!-- Header -->
      <div class="facilitator-header">
        <div class="facilitator-header-content">
          <h2 class="facilitator-title">Facilitator Management</h2>
          <p class="facilitator-subtitle">Comprehensive facilitator oversight, performance tracking, and workforce management.</p>
        </div>
        <div class="facilitator-header-actions">
          <button class="facilitator-action-btn secondary">
            <span class="material-icons">download</span>
            Export Data
          </button>
          <button class="facilitator-action-btn secondary">
            <span class="material-icons">upload</span>
            Import
          </button>
          <button class="facilitator-action-btn primary">
            <span class="material-icons">person_add</span>
            <span>Add Employee</span>
          </button>
        </div>
      </div>


      <!-- Facilitator Navigation Tabs -->
      <div class="facilitator-nav-tabs">
        <button class="facilitator-nav-tab active" data-facilitator-tab="overview">
          <span class="material-icons">bar_chart</span>
          <span>Overview</span>
        </button>
        <button class="facilitator-nav-tab" data-facilitator-tab="directory">
          <span class="material-icons">group</span>
          <span>Directory</span>
        </button>
      </div>

      <!-- Overview Tab Content -->
      <div class="facilitator-tab-content" id="facilitatorOverview">
        <!-- Key Metrics Cards -->
        <div class="facilitator-metrics-grid">
          <div class="facilitator-metric-card blue">
            <div class="facilitator-metric-icon">
              <span class="material-icons">person</span>
            </div>
            <div class="facilitator-metric-content">
              <div class="facilitator-metric-value">{{ facilitators|length }}</div>
              <div class="facilitator-metric-label">Total Facilitators</div>
            </div>
          </div>

          <div class="facilitator-metric-card green">
            <div class="facilitator-metric-icon">
              <span class="material-icons">check_circle</span>
            </div>
            <div class="facilitator-metric-content">
              <div class="facilitator-metric-value">
                {% set active_count = 0 %}
                {% for facilitator in facilitators %}
                  {% if facilitator.preferences %}
                    {% set prefs = facilitator.preferences|from_json %}
                    {% if prefs.get('status', 'active') == 'active' %}
                      {% set active_count = active_count + 1 %}
                    {% endif %}
                  {% else %}
                    {% set active_count = active_count + 1 %}
                  {% endif %}
                {% endfor %}
                {{ active_count }}
              </div>
              <div class="facilitator-metric-label">Active</div>
            </div>
          </div>

          <div class="facilitator-metric-card orange">
            <div class="facilitator-metric-icon">
              <span class="material-icons">schedule</span>
            </div>
            <div class="facilitator-metric-content">
              <div class="facilitator-metric-value">0</div>
              <div class="facilitator-metric-label">Total Hours</div>
            </div>
          </div>

          <div class="facilitator-metric-card purple">
            <div class="facilitator-metric-icon">
              <span class="material-icons">star_outline</span>
            </div>
            <div class="facilitator-metric-content">
              <div class="facilitator-metric-value">4.5</div>
              <div class="facilitator-metric-label">Avg Rating</div>
            </div>
          </div>
        </div>

        <!-- Bottom Section -->
        <div class="facilitator-bottom-section">
          <!-- Workforce Distribution -->
          <div class="workforce-distribution">
            <h3 class="workforce-title">Workforce Distribution</h3>
            <div class="workforce-levels">
              {% set expert_count = 0 %}
              {% set senior_count = 0 %}
              {% set junior_count = 0 %}
              {% for facilitator in facilitators %}
                {% if facilitator.preferences %}
                  {% set prefs = facilitator.preferences|from_json %}
                  {% set level = prefs.get('experience_level', 'junior') %}
                  {% if level == 'expert' %}
                    {% set expert_count = expert_count + 1 %}
                  {% elif level == 'senior' %}
                    {% set senior_count = senior_count + 1 %}
                  {% else %}
                    {% set junior_count = junior_count + 1 %}
                  {% endif %}
                {% else %}
                  {% set junior_count = junior_count + 1 %}
                {% endif %}
              {% endfor %}
              
              <div class="workforce-level">
                <div class="workforce-level-header">
                  <span class="workforce-level-name">Expert Level</span>
                  <span class="workforce-level-count">{{ expert_count }}</span>
                </div>
                <div class="workforce-progress-bar">
                  <div class="workforce-progress-fill expert-progress" style="width: {{ (expert_count / facilitators|length * 100) if facilitators|length > 0 else 0 }}%"></div>
                </div>
              </div>

              <div class="workforce-level">
                <div class="workforce-level-header">
                  <span class="workforce-level-name">Senior Level</span>
                  <span class="workforce-level-count">{{ senior_count }}</span>
                </div>
                <div class="workforce-progress-bar">
                  <div class="workforce-progress-fill senior-progress" style="width: {{ (senior_count / facilitators|length * 100) if facilitators|length > 0 else 0 }}%"></div>
                </div>
              </div>

              <div class="workforce-level">
                <div class="workforce-level-header">
                  <span class="workforce-level-name">Junior Level</span>
                  <span class="workforce-level-count">{{ junior_count }}</span>
                </div>
                <div class="workforce-progress-bar">
                  <div class="workforce-progress-fill junior-progress" style="width: {{ (junior_count / facilitators|length * 100) if facilitators|length > 0 else 0 }}%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <h3 class="quick-actions-title">Quick Actions</h3>
            <div class="quick-actions-list">
              <div class="quick-action-item">
                <div class="quick-action-icon">
                  <span class="material-icons">send</span>
                </div>
                <div class="quick-action-content">
                  <h4 class="quick-action-title">Send Bulk Notifications</h4>
                  <p class="quick-action-desc">Notify all active facilitators</p>
                </div>
              </div>

              <div class="quick-action-item">
                <div class="quick-action-icon">
                  <span class="material-icons">menu_book</span>
                </div>
                <div class="quick-action-content">
                  <h4 class="quick-action-title">Schedule Training Session</h4>
                  <p class="quick-action-desc">Organize skill development</p>
                </div>
              </div>

              <div class="quick-action-item">
                <div class="quick-action-icon">
                  <span class="material-icons">track_changes</span>
                </div>
                <div class="quick-action-content">
                  <h4 class="quick-action-title">Performance Review</h4>
                  <p class="quick-action-desc">Conduct quarterly assessments</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Directory Tab Content -->
      <div class="facilitator-tab-content" id="facilitatorDirectory" style="display: none;">
        <!-- Search and Filter Section -->
        <div class="facilitator-search-section">
          <div class="search-bar">
            <span class="material-icons search-icon">search</span>
            <input type="text" id="facilitatorSearch" placeholder="Search facilitators by name, email, or skills..." class="search-input">
          </div>
          <div class="filter-controls">
            <select id="departmentFilter" class="filter-select">
              <option value="">All Departments</option>
              <option value="computer_science">Computer Science</option>
              <option value="engineering">Engineering</option>
              <option value="mathematics">Mathematics</option>
              <option value="physics">Physics</option>
              <option value="chemistry">Chemistry</option>
            </select>
            <select id="levelFilter" class="filter-select">
              <option value="">All Levels</option>
              <option value="junior">Junior</option>
              <option value="intermediate">Intermediate</option>
              <option value="senior">Senior</option>
              <option value="expert">Expert</option>
            </select>
            <select id="statusFilter" class="filter-select">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="on_leave">On Leave</option>
            </select>
          </div>
        </div>

        <!-- Results Summary -->
        <div class="results-summary">
          <span id="resultsCount">Showing {{ facilitators|length or 0 }} of {{ facilitators|length or 0 }} facilitators</span>
        </div>

        <!-- Facilitator List -->
        <div class="facilitator-list" id="facilitatorList">
          {% for facilitator in facilitators %}
          <div class="facilitator-card" data-facilitator-id="{{ facilitator.id }}">
            <div class="facilitator-avatar">
              <span class="material-icons">person</span>
            </div>
            <div class="facilitator-info">
              <div class="facilitator-name">{{ facilitator.full_name }}</div>
              <div class="facilitator-badges">
                <span class="badge badge-experience">
                  {% if facilitator.preferences %}
                    {% set prefs = facilitator.preferences|from_json %}
                    {{ prefs.get('experience_level', 'junior')|title }}
                  {% else %}
                    Junior
                  {% endif %}
                </span>
                <span class="badge badge-status">
                  {% if facilitator.preferences %}
                    {% set prefs = facilitator.preferences|from_json %}
                    {{ prefs.get('status', 'active')|title }}
                  {% else %}
                    Active
                  {% endif %}
                </span>
              </div>
              <div class="facilitator-details">
                <span class="facilitator-role">
                  {% if facilitator.preferences %}
                    {% set prefs = facilitator.preferences|from_json %}
                    {{ prefs.get('position', 'lab_facilitator')|replace('_', ' ')|title }}
                  {% else %}
                    Lab Facilitator
                  {% endif %}
                </span>
                <span class="facilitator-department">
                  {% if facilitator.preferences %}
                    {% set prefs = facilitator.preferences|from_json %}
                    {{ prefs.get('department', 'general')|replace('_', ' ')|title }}
                  {% else %}
                    General
                  {% endif %}
                </span>
              </div>
              <div class="facilitator-metrics">
                <div class="metric-item">
                  <span class="material-icons">star</span>
                  <span>4.5</span>
                </div>
                <div class="metric-item">
                  <span class="material-icons">schedule</span>
                  <span>0h Hours</span>
                </div>
                <div class="metric-item">
                  <span class="material-icons">folder</span>
                  <span>0 Units</span>
                </div>
                <div class="metric-item">
                  <span class="material-icons">attach_money</span>
                  <span>
                    {% if facilitator.preferences %}
                      {% set prefs = facilitator.preferences|from_json %}
                      ${{ prefs.get('hourly_rate', 25) }} Rate
                    {% else %}
                      $25 Rate
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
            <div class="facilitator-actions">
              <button class="action-btn edit" title="Edit Profile" onclick="openEditModal({{ facilitator.id }}, '{{ facilitator.full_name }}', '{{ facilitator.email }}')">
                <span class="material-icons">person</span>
              </button>
              <button class="action-btn key" title="Edit Details" onclick="openEditModal({{ facilitator.id }}, '{{ facilitator.full_name }}', '{{ facilitator.email }}')">
                <span class="material-icons">edit</span>
              </button>
              <div class="dropdown-container">
                <button class="action-btn more" title="More Options" onclick="toggleDropdown({{ facilitator.id }})">
                  <span class="material-icons">more_vert</span>
                </button>
                <div class="dropdown-menu" id="dropdown-{{ facilitator.id }}" style="display: none;">
                  <button class="dropdown-item" onclick="disableAccount({{ facilitator.id }}, '{{ facilitator.full_name }}')">
                    <span class="material-icons">person_off</span>
                    Disable Account
                  </button>
                  <button class="dropdown-item delete" onclick="deleteAccount({{ facilitator.id }}, '{{ facilitator.full_name }}')">
                    <span class="material-icons">delete</span>
                    Delete Employee Account
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
          
          {% if not facilitators %}
          <div class="empty-state">
            <span class="material-icons">group</span>
            <h3>No facilitators found</h3>
            <p>Add your first facilitator using the "Add Employee" button above.</p>
          </div>
          {% endif %}
        </div>
      </div>

      </div>
    </div>

  </main>

  <!-- Add Employee Modal -->
  <div class="modal-overlay" id="addEmployeeModal" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Add New Facilitator</h2>
        <p class="modal-description">Add a new facilitator with their contact information and qualifications.</p>
        <button class="modal-close" id="closeModal">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <form class="modal-form" id="addEmployeeForm">
        <div class="form-row">
          <div class="form-column">
            <div class="form-group">
              <label for="role" class="form-label">Role</label>
              <select id="role" name="role" class="form-select">
                <option value="lab_facilitator" selected>Lab Facilitator</option>
                <option value="senior_facilitator">Senior Facilitator</option>
                <option value="lead_facilitator">Lead Facilitator</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="fullName" class="form-label">Full Name</label>
              <input type="text" id="fullName" name="fullName" class="form-input" placeholder="Enter full name" required>
            </div>
            
            <div class="form-group">
              <label for="phone" class="form-label">Phone</label>
              <input type="tel" id="phone" name="phone" class="form-input" placeholder="Enter phone number" required>
            </div>
            
            <div class="form-group">
              <label for="position" class="form-label">Position</label>
              <select id="position" name="position" class="form-select">
                <option value="">Select position</option>
                <option value="tutor">Tutor</option>
                <option value="demonstrator">Demonstrator</option>
                <option value="assistant">Assistant</option>
                <option value="supervisor">Supervisor</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="experienceLevel" class="form-label">Experience Level</label>
              <select id="experienceLevel" name="experienceLevel" class="form-select">
                <option value="junior" selected>Junior</option>
                <option value="intermediate">Intermediate</option>
                <option value="senior">Senior</option>
                <option value="expert">Expert</option>
              </select>
            </div>
          </div>
          
          <div class="form-column">
            <div class="form-group">
              <label for="email" class="form-label">Email</label>
              <input type="email" id="email" name="email" class="form-input" placeholder="Enter email address" required>
            </div>
            
            <div class="form-group">
              <label for="hourlyRate" class="form-label">Hourly Rate ($)</label>
              <input type="number" id="hourlyRate" name="hourlyRate" class="form-input" value="25" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
              <label for="department" class="form-label">Department</label>
              <select id="department" name="department" class="form-select">
                <option value="">Select department</option>
                <option value="computer_science">Computer Science</option>
                <option value="engineering">Engineering</option>
                <option value="mathematics">Mathematics</option>
                <option value="physics">Physics</option>
                <option value="chemistry">Chemistry</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="status" class="form-label">Status</label>
              <select id="status" name="status" class="form-select">
                <option value="active" selected>Active</option>
                <option value="inactive">Inactive</option>
                <option value="on_leave">On Leave</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn-primary">Add Facilitator</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Employee Modal -->
  <div class="modal-overlay" id="editEmployeeModal" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Edit Employee Details</h2>
        <p class="modal-description">Update employee information and manage account settings.</p>
        <button class="modal-close" id="closeEditModal">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <form class="modal-form" id="editEmployeeForm">
        <input type="hidden" id="editEmployeeId" name="employeeId">
        
        <div class="form-row">
          <div class="form-column">
            <div class="form-group">
              <label for="editRole" class="form-label">Role</label>
              <select id="editRole" name="role" class="form-select">
                <option value="lab_facilitator">Lab Facilitator</option>
                <option value="senior_facilitator">Senior Facilitator</option>
                <option value="lead_facilitator">Lead Facilitator</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="editFullName" class="form-label">Full Name</label>
              <input type="text" id="editFullName" name="fullName" class="form-input" placeholder="Enter full name" required>
            </div>
            
            <div class="form-group">
              <label for="editPhone" class="form-label">Phone</label>
              <input type="tel" id="editPhone" name="phone" class="form-input" placeholder="Enter phone number" required>
            </div>
            
            <div class="form-group">
              <label for="editPosition" class="form-label">Position</label>
              <select id="editPosition" name="position" class="form-select">
                <option value="">Select position</option>
                <option value="tutor">Tutor</option>
                <option value="demonstrator">Demonstrator</option>
                <option value="assistant">Assistant</option>
                <option value="supervisor">Supervisor</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="editExperienceLevel" class="form-label">Experience Level</label>
              <select id="editExperienceLevel" name="experienceLevel" class="form-select">
                <option value="junior">Junior</option>
                <option value="intermediate">Intermediate</option>
                <option value="senior">Senior</option>
                <option value="expert">Expert</option>
              </select>
            </div>
          </div>
          
          <div class="form-column">
            <div class="form-group">
              <label for="editEmail" class="form-label">Email</label>
              <input type="email" id="editEmail" name="email" class="form-input" placeholder="Enter email address" required>
            </div>
            
            <div class="form-group">
              <label for="editHourlyRate" class="form-label">Hourly Rate ($)</label>
              <input type="number" id="editHourlyRate" name="hourlyRate" class="form-input" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
              <label for="editDepartment" class="form-label">Department</label>
              <select id="editDepartment" name="department" class="form-select">
                <option value="">Select department</option>
                <option value="computer_science">Computer Science</option>
                <option value="engineering">Engineering</option>
                <option value="mathematics">Mathematics</option>
                <option value="physics">Physics</option>
                <option value="chemistry">Chemistry</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="editStatus" class="form-label">Status</label>
              <select id="editStatus" name="status" class="form-select">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="on_leave">On Leave</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Password Reset Section -->
        <div class="password-reset-section">
          <h3 class="password-reset-title">Password Management</h3>
          <div class="password-reset-options">
            <button type="button" class="btn-secondary" onclick="sendResetLink()">
              <span class="material-icons">email</span>
              Send Reset Link to Employee
            </button>
            <button type="button" class="btn-secondary" onclick="adminResetPassword()">
              <span class="material-icons">lock_reset</span>
              Admin Reset Password
            </button>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelEditBtn">Cancel</button>
          <button type="submit" class="btn-primary">Update Employee</button>
        </div>
      </form>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/admin.js') }}" defer></script>
</body>
</html>


