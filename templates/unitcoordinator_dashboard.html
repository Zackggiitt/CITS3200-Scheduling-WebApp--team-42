<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit Coordinator Portal</title>

  <!-- Tailwind (utility only) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <!-- Material Icons (filled) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <!-- Flatpickr (date picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

  <!-- FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='uc.css') }}" />
  <style>
    /* small helper styles for ‚ÄúOutside range‚Äù label on day headers */
    .fc-daygrid-day.out-of-range,
    .fc-timegrid-col.out-of-range {
      opacity: .5;
      pointer-events: none;
      background-image: repeating-linear-gradient(
        -45deg, rgba(229,231,235,.8), rgba(229,231,235,.8) 6px, transparent 6px, transparent 12px
      );
    }
    .fc-col-header-cell .fc-outside-chip {
      display: inline-block;
      font-size: 10px;
      color: #6b7280;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 9999px;
      padding: 2px 6px;
      margin-left: 6px;
      vertical-align: middle;
    }
    
    /* Profile button styling */
    .user-profile-container {
      position: relative;
    }
    
    .user-profile-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }
    
    .user-profile-btn:hover {
      background-color: #f3f4f6;
    }
    
    .user-profile-btn:active {
      background-color: #e5e7eb;
    }
    
    .profile-arrow {
      font-size: 18px;
      color: #6b7280;
      transition: transform 0.2s ease;
    }
    
    .user-profile-container:hover .profile-arrow {
      transform: rotate(180deg);
    }
    
    /* Profile dropdown styling */
    .profile-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      width: 280px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      z-index: 1000;
      margin-top: 8px;
    }
    
    .user-profile-container:hover .profile-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .profile-dropdown-header {
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px 12px 0 0;
    }
    
    .profile-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .profile-icon {
      font-size: 40px;
      color: #6366f1;
    }
    
    .profile-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
    }
    
    .profile-email {
      color: #6b7280;
      font-size: 14px;
    }
    
    .profile-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 0;
    }
    
    .profile-dropdown-menu {
      padding: 8px 0;
    }
    
    .profile-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: #374151;
      text-decoration: none;
      transition: background-color 0.2s ease;
      font-size: 14px;
    }
    
    .profile-menu-item:hover {
      background-color: #f3f4f6;
      color: #1f2937;
    }
    
    .profile-menu-item .material-icons {
      font-size: 20px;
      color: #6b7280;
    }
    
    .profile-menu-item:hover .material-icons {
      color: #6366f1;
    }
    
    .logout-item {
      color: #dc2626;
    }
    
    .logout-item:hover {
      background-color: #fef2f2;
      color: #b91c1c;
    }
    
    .logout-item .material-icons {
      color: #dc2626;
    }
    
    .logout-item:hover .material-icons {
      color: #b91c1c;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- HEADER -->
  <header class="header">
    <div class="container">
      <div class="left" aria-label="Application">
        <span class="material-icons icon-school" aria-hidden="true">school</span>
        <h1 class="title">Unit Coordinator Portal</h1>
      </div>

      <div class="right">
        <button class="create-unit-btn" type="button" aria-label="Create Unit" onclick="openCreateUnitModal()">
          <span class="material-icons icon-add" aria-hidden="true">add</span>
          <span>Create Unit</span>
        </button>

        <div class="notification-container">
          <button class="icon-btn notification-btn" type="button" aria-label="Notifications">
            <span class="material-icons" aria-hidden="true">notifications</span>
          </button>
          {% if notifications and notifications > 0 %}
            <span class="notification-badge" aria-label="{{ notifications }} unread notifications">
              {{ notifications }}
            </span>
          {% endif %}
        </div>

        <div class="user" aria-label="Current user">
          <div class="user-profile-container">
            <button class="user-profile-btn" aria-label="Open profile">
              <span class="material-icons icon-account" aria-hidden="true">account_circle</span>
              <span class="user-name">{{ user.full_name }}</span>
              <span class="material-icons profile-arrow" aria-hidden="true">arrow_drop_down</span>
            </button>
            
            <!-- Profile Dropdown Menu -->
            <div class="profile-dropdown" id="profileDropdown">
              <div class="profile-dropdown-header">
                <div class="profile-info">
                  <span class="material-icons profile-icon">account_circle</span>
                  <div>
                    <div class="profile-name">{{ user.full_name }}</div>
                    <div class="profile-email">{{ user.email }}</div>
                  </div>
                </div>
              </div>
              
              <div class="profile-dropdown-divider"></div>
              
              <div class="profile-dropdown-menu">
                <a href="#" class="profile-menu-item" onclick="openProfilePage()">
                  <span class="material-icons">person</span>
                  <span>View Profile</span>
                </a>
                <a href="#" class="profile-menu-item" onclick="openAccountSettings()">
                  <span class="material-icons">settings</span>
                  <span>Account Settings</span>
                </a>
                <a href="#" class="profile-menu-item" onclick="openPreferences()">
                  <span class="material-icons">tune</span>
                  <span>Preferences</span>
                </a>
                <a href="#" class="profile-menu-item" onclick="openNotifications()">
                  <span class="material-icons">notifications</span>
                  <span>Notifications</span>
                </a>
                
                <div class="profile-dropdown-divider"></div>
                
                <a href="#" class="profile-menu-item" onclick="openHelp()">
                  <span class="material-icons">help</span>
                  <span>Help & Support</span>
                </a>
                <a href="#" class="profile-menu-item" onclick="openAbout()">
                  <span class="material-icons">info</span>
                  <span>About</span>
                </a>
                
                <div class="profile-dropdown-divider"></div>
                
                <a href="#" class="profile-menu-item logout-item" onclick="confirmLogout()">
                  <span class="material-icons">logout</span>
                  <span>Sign Out</span>
                </a>
              </div>
            </div>
          </div>
        </div>

        <span class="role-badge">
          {{ user.role.value.replace('_', ' ') | title }}
        </span>

        <!-- Hidden logout form for profile dropdown to use -->
        <form method="POST" action="{{ url_for('auth.logout') }}" class="logout-form" style="display: none;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        </form>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="flex justify-center mt-10">
    {% if not units %}
      <!-- Empty state -->
      <div class="bg-white shadow rounded-xl p-6 w-full max-w-md text-center">
        <span class="material-icons text-gray-700 text-5xl mb-3">apartment</span>
        <h2 class="text-lg font-semibold mb-2">Create Your First Unit</h2>
        <p class="text-gray-600 text-sm mb-4">
          Get started by creating your first unit. You‚Äôll be able to manage facilitators, schedules, and approvals for each unit you create.
        </p>
        <button onclick="openCreateUnitModal()" class="w-full py-2 bg-gray-900 text-white rounded-md hover:bg-gray-800 flex items-center justify-center gap-2">
          <span class="material-icons text-sm">add</span>
          Create Unit
        </button>
      </div>

    {% else %}
      {% set unit = current_unit or (units|first) %}
      <div class="w-full max-w-5xl">

        <!-- GREETING BANNER -->
        <div class="greeting-banner mb-6">
          <div>
            <h2 id="greeting-message" data-user-name="{{ user.first_name }}">, {{ user.first_name }}! üëã</h2>
            <p>Here's what's happening with your units.</p>
          </div>
          <div class="greeting-icon">
            <span class="material-icons" aria-hidden="true">wb_sunny</span>
          </div>
        </div>

        <!-- UNIT CARD -->
        <article class="unit-card bg-white border rounded-xl p-6 shadow-sm flex items-start justify-between mb-4">
          <div>
            <div class="flex items-center gap-3 meta-row">
              <h2 class="text-2xl font-bold tracking-tight">{{ unit.unit_code }}</h2>

              <span class="chip chip--neutral">
                {{ unit.semester }}, {{ unit.year }}
              </span>

              {% set end = unit.end_date %}
              {% set is_completed = end and (end if end is string else end) < today %}
              {% if is_completed %}
                <span class="chip chip--completed">
                  <span class="material-icons">check_circle</span>
                  Completed
                </span>
              {% else %}
                <span class="chip chip--active">
                  <span class="material-icons">schedule</span>
                  Active
                </span>
              {% endif %}
            </div>

            <p class="mt-2 text-gray-800 font-medium">{{ unit.unit_name }}</p>

            <p class="mt-2 text-gray-500 text-sm flex items-center gap-2">
              <span class="material-icons text-base">event</span>
              {% if unit.session_count is defined %}{{ unit.session_count }} sessions ‚Ä¢ {% endif %}
              {% set start = unit.start_date %}
              {% if start %}{{ start if start is string else start.strftime("%m/%d/%Y") }}{% endif %}
              {% if start and end %} - {% endif %}
              {% if end %}{{ end if end is string else end.strftime("%m/%d/%Y") }}{% endif %}
            </p>
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-3">
            <!-- All Units -->
            <div class="relative card-actions all-units">
              <details class="group">
                <summary class="list-none inline-flex items-center gap-2">
                  <span class="material-icons text-base">view_list</span>
                  All Units
                  <span class="material-icons text-base">expand_more</span>
                </summary>
                <ul class="menu">
                  {% for u in units %}
                    {% set uend = u.end_date %}
                    {% set ucompleted = uend and (uend if uend is string else uend) < today %}
                    <li class="border-b last:border-0">
                      <a href="{{ url_for('unitcoordinator.dashboard', unit=u.id) }}"
                        class="block px-3 py-2 hover:bg-gray-50">
                        <div class="flex items-center gap-2">
                          <div class="font-semibold">{{ u.unit_code }}</div>
                          <span class="chip {{ 'chip--completed' if ucompleted else 'chip--active' }}">
                            <span class="material-icons">{{ 'check_circle' if ucompleted else 'schedule' }}</span>
                            {{ 'Completed' if ucompleted else 'Active' }}
                          </span>
                        </div>
                        <div class="text-xs text-gray-500">{{ u.unit_name }}</div>
                      </a>
                    </li>
                  {% endfor %}
                  <li class="border-t">
                    <button type="button" onclick="openCreateUnitModal()"
                            class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 flex items-center gap-2">
                      <span class="material-icons text-base">add</span>
                      New Unit
                    </button>
                  </li>
                </ul>
              </details>
            </div>

            {% if units|length > 1 %}
            <!-- Switch Unit -->
            <div class="relative card-actions">
              <details class="group">
                <summary class="list-none inline-flex items-center gap-2">
                  Switch Unit
                  <span class="material-icons text-base">expand_more</span>
                </summary>
                <ul class="menu">
                  {% for other in units if other.id != unit.id %}
                    <li>
                      <a href="{{ url_for('unitcoordinator.dashboard', unit=other.id) }}"
                        class="block px-3 py-2 text-sm hover:bg-gray-50">
                        {{ other.unit_code }} ‚Äî {{ other.unit_name }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              </details>
            </div>
            {% endif %}
          </div>
        </article>

        <!-- COMPLETED BANNER -->
        {% set end = unit.end_date %}
        {% set is_completed = end and (end if end is string else end) < today %}
        {% if is_completed %}
        <div id="unit-complete-{{ unit.id }}" class="uc-banner uc-banner--success" role="status" aria-live="polite">
          <div class="uc-banner__icon">
            <span class="material-icons" aria-hidden="true">check_circle</span>
          </div>
          <div class="uc-banner__body">
            <div class="uc-banner__title">This unit has been completed</div>
            <div class="uc-banner__text">
              Unit ended on {{ end if end is string else end.strftime("%m/%d/%Y") }}. You can still view all data but editing is limited.
            </div>
          </div>
          <button type="button" class="uc-banner__close" aria-label="Dismiss" data-notice-id="unit-complete-{{ unit.id }}">
            <span class="material-icons" aria-hidden="true">close</span>
          </button>
        </div>
        {% endif %}

        <!-- TABS -->
        <div class="mt-6 uc-tabs-wrap">
          <nav class="uc-tabs uc-tabs--spread" role="tablist" aria-label="Unit sections" data-unit-id="{{ unit.id }}">
            <button type="button" role="tab" id="tab-dashboard" class="uc-tab is-active"
                    aria-selected="true" aria-controls="panel-dashboard" tabindex="0" data-tab="dashboard">
              <span class="material-icons" aria-hidden="true">bar_chart</span>
              <span>Dashboard</span>
            </button>

            <button type="button" role="tab" id="tab-schedule" class="uc-tab"
                    aria-selected="false" aria-controls="panel-schedule" tabindex="-1" data-tab="schedule">
              <span class="material-icons" aria-hidden="true">event_note</span>
              <span>Schedule</span>
            </button>

            <button type="button" role="tab" id="tab-staffing" class="uc-tab"
                    aria-selected="false" aria-controls="panel-staffing" tabindex="-1" data-tab="staffing">
              <span class="material-icons" aria-hidden="true">group</span>
              <span>Facilitators</span>
            </button>

            <button type="button" role="tab" id="tab-team" class="uc-tab"
                    aria-selected="false" aria-controls="panel-team" tabindex="-1" data-tab="team">
              <span class="material-icons" aria-hidden="true">task_alt</span>
              <span>Swap &amp; Approvals</span>
              {% if approvals_count %}
                <span class="uc-badge" aria-label="{{ approvals_count }} pending approvals">{{ approvals_count }}</span>
              {% endif %}
            </button>
          </nav>

          <!-- SCHEDULE PANEL -->
          <section id="panel-schedule" class="uc-panel" role="tabpanel" aria-labelledby="tab-schedule" hidden>
            <!-- Schedule Management Header -->
            <div class="schedule-header">
              <div class="schedule-title">
                <span class="material-icons">event</span>
                <h2>Schedule Management</h2>
              </div>
              
              <!-- View Toggle -->
              <div class="view-toggle">
                <button type="button" class="view-btn active" data-view="calendar">
                  <span class="material-icons">calendar_view_week</span>
                  Calendar View
                </button>
                <button type="button" class="view-btn" data-view="list">
                  <span class="material-icons">list</span>
                  List View
                </button>
              </div>
            </div>

            <!-- Course Info -->
            <div class="course-info">
              <h3>{{ unit.unit_code }} Schedule</h3>
              <p>Manage {{ unit.session_count or 0 }} sessions from university timetable with facilitator assignments.</p>
              
              <!-- Auto Assign Button -->
              <button type="button" class="auto-assign-btn">
                <span class="material-icons">auto_awesome</span>
                Auto-Assign Facilitators
              </button>
            </div>

            <!-- Week Navigation -->
            <div class="week-navigation">
              <button type="button" class="nav-btn" id="prev-week">
                <span class="material-icons">chevron_left</span>
              </button>
              <span class="week-text">This Week</span>
              <button type="button" class="nav-btn" id="next-week">
                <span class="material-icons">chevron_right</span>
              </button>
              <div class="current-week" id="current-week">Week of September 1, 2025</div>
            </div>

            <!-- Assignment Status Legend -->
            <div class="status-legend">
              <div class="legend-item">
                <div class="legend-dot approved"></div>
                <span>Approved</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot pending"></div>
                <span>Pending</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot unassigned"></div>
                <span>Unassigned</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot proposed"></div>
                <span>Proposed</span>
              </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="schedule-view">
              <div class="schedule-grid-container">
                <div class="schedule-grid" id="schedule-grid">
                  <!-- Days will be populated by JavaScript -->
                </div>
              </div>
            </div>

            <!-- List View -->
            <div id="list-view" class="schedule-view" style="display: none;">
              <!-- Session Statistics Cards -->
              <div class="session-stats">
                <div class="stat-card">
                  <div class="stat-number" id="total-sessions">0</div>
                  <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number approved" id="approved-sessions">0</div>
                  <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number pending" id="pending-sessions">0</div>
                  <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number unassigned" id="unassigned-sessions">0</div>
                  <div class="stat-label">Unassigned</div>
                </div>
              </div>

              <!-- Filters & Search -->
              <div class="filters-section">
                <div class="filters-header">
                  <span class="material-icons">tune</span>
                  <h3>Filters & Search</h3>
                </div>
                
                <div class="filters-controls">
                  <div class="search-box">
                    <span class="material-icons">search</span>
                    <input type="text" id="session-search" placeholder="Search by activity, location, facilitator, or module...">
                  </div>
                  
                  <div class="filter-dropdowns">
                    <select id="status-filter" class="filter-select">
                      <option value="">All Status</option>
                      <option value="approved">Approved</option>
                      <option value="pending">Pending</option>
                      <option value="unassigned">Unassigned</option>
                      <option value="proposed">Proposed</option>
                    </select>
                    
                    <select id="day-filter" class="filter-select">
                      <option value="">All Days</option>
                      <option value="monday">Monday</option>
                      <option value="tuesday">Tuesday</option>
                      <option value="wednesday">Wednesday</option>
                      <option value="thursday">Thursday</option>
                      <option value="friday">Friday</option>
                    </select>
                    
                    <select id="sort-filter" class="filter-select">
                      <option value="time">Time</option>
                      <option value="title">Title</option>
                      <option value="facilitator">Facilitator</option>
                      <option value="status">Status</option>
                    </select>
                  </div>
                  
                  <div class="sort-control">
                    <button type="button" id="sort-direction" class="sort-btn">
                      <span class="material-icons">unfold_more</span>
                      Ascending
                    </button>
                  </div>
                </div>
                
                <div class="session-count">
                  Showing <span id="filtered-count">{{ unit.session_count or 0 }}</span> of <span id="total-count">{{ unit.session_count or 0 }}</span> sessions
                </div>
              </div>

              <!-- Sessions List -->
              <div class="sessions-list-section">
                <div class="sessions-header">
                  <span class="material-icons">event_note</span>
                  <h3>Sessions List</h3>
                  <span class="session-badge" id="session-count">{{ unit.session_count or 0 }} sessions</span>
                </div>
                
                <div class="sessions-container" id="sessions-container">
                  <!-- Sessions will be populated by JavaScript -->
                  <!-- To inject session data, call: setSessionData(sessionDataArray) -->
                </div>
              </div>
            </div>
          </section>

          <!-- DASHBOARD PANEL -->
          <section id="panel-dashboard" class="uc-panel" role="tabpanel" aria-labelledby="tab-dashboard">
             <!-- Session Swap Management -->
            <div class="mt-6">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h2 class="text-xl font-semibold">Schedule Overview</h2>
                  <p class="text-gray-600 text-sm">Track total sessions, assignments, conflicts, and facilitators in this unit</p>
                </div>
              </div>
              
              <!-- Stats Grid - Compact size -->
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white border rounded-xl p-4 text-center">
                  <div class="text-2xl font-bold text-orange-600 mb-1" data-stat="total_schedule">{{ fac_stats.total_schedule }}</div>
                  <div class="text-xs text-gray-600">Total Schedule</div>
                </div>
                <div class="bg-white border rounded-xl p-4 text-center">
                  <div class="text-2xl font-bold text-green-600 mb-1" data-stat="schedule_assigned">{{ fac_stats.schedule_assigned }}</div>
                  <div class="text-xs text-gray-600">Schedule Assigned</div>
                </div>
                <div class="bg-white border rounded-xl p-4 text-center">
                  <div class="text-2xl font-bold text-red-600 mb-1" data-stat="schedule_conflicts">{{ fac_stats.schedule_conflicts }}</div>
                  <div class="text-xs text-gray-600">Schedule Conflicts</div>
                </div>
                <div class="bg-white border rounded-xl p-4 text-center">
                  <div class="text-2xl font-bold text-blue-600 mb-1" data-stat="total_facilitators">{{ fac_stats.total_facilitators }}</div>
                  <div class="text-xs text-gray-600">Total Facilitators</div>
                </div>
              </div>

              <!-- Sessions Overview Widget  -->
              <div class="mt-6">
                <div class="mb-3">
                  <h3 class="text-lg font-semibold">Session Overview</h3>
                  <p class="text-gray-600 text-xs">Track sessions, attendance, and upcoming schedule at a glance</p>
                </div>
                
                <div id="panel-dashboard">
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Today's Sessions -->
                    <section class="bg-blue-50 border border-blue-200 rounded-2xl p-5">
                      <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Today's Sessions</h3>
                        <span class="material-icons text-blue-500">event</span>
                      </div>
                      <div id="todaySessionsList" class="flex gap-3"></div>
                    </section>

                    <!-- Upcoming Sessions -->
                    <section class="bg-purple-50 border border-purple-200 rounded-2xl p-5">
                      <div class="flex items-center justify-between mb-1">
                        <h3 class="text-lg font-semibold">Upcoming Sessions</h3>
                        <span class="material-icons text-purple-500">schedule</span>
                      </div>
                      <p class="text-sm text-gray-600 mb-3">
                        You have <span id="weekSessionCount">0</span> sessions this week
                      </p>

                      <!-- mini week calendar -->
                      <div id="miniCalendarDays" class="grid grid-cols-7 gap-2 mb-4"></div>

                      <!-- list -->
                      <div id="upcomingSessionsList" class="space-y-2"></div>
                    </section>

                      <!-- Attendance Summary -->
                      <section id="attendanceSummaryCard"
                            class="bg-white border border-gray-200 rounded-2xl p-4">
                      <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-gray-900">Attendance Summary</h3>
                        <span class="material-icons text-indigo-500 bg-indigo-50 p-1.5 rounded-lg text-sm">pie_chart</span>
                      </div>
                      <div class="gauge-wrap">
                        <canvas id="attendanceGauge"></canvas>
                        <div id="attendanceGaugeLabel">0%</div>
                      </div>
                      <div class="gauge-caption">Overall attendance rate</div>
                    </section>
                  </div>
                  <section id="attendanceSummaryClone"
                        class="bg-white border border-gray-200 rounded-2xl p-3 mt-6"
                        style="width: 350px; height: 170px; margin-left: auto;">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold">Facilitator Session Count</h3>
                    <span class="material-icons text-gray-500 text-sm">bar_chart</span>
                  </div>
                  <div class="clone-content">
                    This is a placeholder for the bar chart.
                  </div>
                </section>
            </div>
          </section>


          <!-- Other panels -->
          <section id="panel-staffing" class="uc-panel" role="tabpanel" aria-labelledby="tab-staffing" hidden>
            {# --- Session staffing stats row --- #}
            <div class="uc-stats">
              <div class="uc-stat">
                <div class="uc-stat__value uc-stat__value--blue">{{ stats.total }}</div>
                <div class="uc-stat__label">Total Sessions</div>
              </div>
              <div class="uc-stat">
                <div class="uc-stat__value uc-stat__value--green">{{ stats.fully }}</div>
                <div class="uc-stat__label">Fully Staffed</div>
              </div>
              <div class="uc-stat">
                <div class="uc-stat__value uc-stat__value--orange">{{ stats.needs_lead }}</div>
                <div class="uc-stat__label">Needs Lead</div>
              </div>
              <div class="uc-stat">
                <div class="uc-stat__value uc-stat__value--red">{{ stats.unstaffed }}</div>
                <div class="uc-stat__label">Unstaffed</div>
              </div>
            </div>

            {# --- Facilitator Setup Progress --- #}
            {% set fp = fac_progress or {} %}
            {% set total = fp.total or 0 %}
            {% set acct_pct = (fp.account * 100 // total) if total else 0 %}
            {% set avail_pct = (fp.availability * 100 // total) if total else 0 %}
            {% set ready_pct = (fp.ready * 100 // total) if total else 0 %}

            <div class="mt-6 bg-gray-50 border rounded-2xl p-5">
              <header class="flex items-center gap-2 mb-2">
                <span class="material-icons text-gray-700">group</span>
                <h3 class="font-semibold text-gray-900">Facilitator Setup Progress</h3>
              </header>
              <p class="text-sm text-gray-600 mb-5">
                Track how many facilitators have completed their account setup and availability configuration.
              </p>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div class="text-3xl font-semibold text-blue-600">{{ total }}</div>
                  <div class="text-sm text-gray-600 mt-1">Total Facilitators</div>
                </div>

                <div>
                  <div class="text-center">
                    <div class="text-3xl font-semibold text-green-600">{{ fp.account }}</div>
                    <div class="text-sm text-gray-600 mt-1">Account Setup</div>
                  </div>
                  <div class="mt-2 h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-2 bg-gray-900 rounded-full" style="width: {{ acct_pct }}%"></div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">{{ acct_pct }}% complete</div>
                </div>

                <div>
                  <div class="text-center">
                    <div class="text-3xl font-semibold" style="color:#7c3aed">{{ fp.availability }}</div>
                    <div class="text-sm text-gray-600 mt-1">Availability Set</div>
                  </div>
                  <div class="mt-2 h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-2 bg-gray-900 rounded-full" style="width: {{ avail_pct }}%"></div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">{{ avail_pct }}% complete</div>
                </div>

                <div>
                  <div class="text-center">
                    <div class="text-3xl font-semibold text-emerald-600">{{ fp.ready }}</div>
                    <div class="text-sm text-gray-600 mt-1">Fully Ready</div>
                  </div>
                  <div class="mt-2 h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-2 bg-gray-900 rounded-full" style="width: {{ ready_pct }}%"></div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">{{ ready_pct }}% complete</div>
                </div>
              </div>
            </div>

            {# --- Facilitator Details (SKILLS, not experience) --- #}
            <div class="mt-6 bg-white border rounded-2xl p-5 fac-list">
              <header class="flex items-center justify-between gap-3 mb-4">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-gray-700">manage_accounts</span>
                  <h3 class="font-semibold text-gray-900">Facilitator Details</h3>
                  <span class="ml-2 text-xs text-gray-500">{{ facilitators|length }} of {{ fac_progress.total }}</span>
                </div>

                <!-- search/filter placeholders -->
                <div class="flex items-center gap-2">
                  <label class="relative">
                    <span class="material-icons absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-base">search</span>
                    <input type="search" class="pl-8 pr-3 py-1.5 border rounded-lg text-sm focus:outline-none"
                          placeholder="Search facilitators‚Ä¶" aria-label="Search facilitators">
                  </label>
                  <details class="relative">
                    <summary class="list-none inline-flex items-center gap-1 px-3 py-1.5 border rounded-lg text-sm cursor-pointer">
                      All Status <span class="material-icons text-base">expand_more</span>
                    </summary>
                    <ul class="absolute right-0 mt-2 w-40 bg-white border rounded-lg shadow text-sm">
                      <li><button type="button" class="block w-full text-left px-3 py-2 hover:bg-gray-50">All Status</button></li>
                      <li><button type="button" class="block w-full text-left px-3 py-2 hover:bg-gray-50">Ready</button></li>
                      <li><button type="button" class="block w-full text-left px-3 py-2 hover:bg-gray-50">Needs Availability</button></li>
                      <li><button type="button" class="block w-full text-left px-3 py-2 hover:bg-gray-50">Pending Setup</button></li>
                    </ul>
                  </details>
                </div>
              </header>

              {% if facilitators %}
                {% for f in facilitators %}
                  <article class="border rounded-xl p-4 mb-3">
                    <div class="flex items-start justify-between gap-6">
                      <!-- Left: identity + contact -->
                      <div>
                        <div class="flex items-center gap-3">
                          <h4 class="font-semibold text-gray-900">{{ f.name }}</h4>

                          {% if f.is_ready %}
                            <span class="status-badge status-badge--green">
                              <span class="material-icons">check_circle</span> Ready
                            </span>

                          {% elif f.has_profile and not f.has_availability %}
                            <span class="status-badge status-badge--amber">
                              <span class="material-icons">hourglass_bottom</span> Pending
                            </span>
                            <span class="status-badge status-badge--amber">
                              <span class="material-icons">priority_high</span> Needs Availability
                            </span>

                          {% else %}
                            <span class="status-badge status-badge--gray">
                              <span class="material-icons">pause_circle</span> Inactive
                            </span>
                            <span class="status-badge status-badge--rose">
                              <span class="material-icons">warning</span> Setup Required
                            </span>
                          {% endif %}

                        </div>

                        <div class="mt-2 space-y-1 text-sm text-gray-800">
                          <div class="flex items-center gap-2">
                            <span class="material-icons text-base text-gray-500">email</span>
                            <a href="mailto:{{ f.email }}" class="text-blue-700 hover:underline">{{ f.email }}</a>
                          </div>
                          <div class="flex items-center gap-2">
                            <span class="material-icons text-base text-gray-500">call</span>
                            <span>{{ f.phone or '‚Äî' }}</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <span class="material-icons text-base text-gray-500">badge</span>
                            <span>{{ f.staff_number or '‚Äî' }}</span>
                          </div>
                        </div>
                      </div>

                      <!-- Right: skills + placeholders -->
                      <div class="min-w-[420px]">
                        <div class="text-sm text-gray-500 mb-1">Skills</div>
                        {% if f.skills and f.skills|length %}
                          <div class="flex flex-wrap gap-2 mb-3">
                            {% for s in f.skills %}
                              <span class="inline-flex items-center rounded-full border border-gray-200 px-2 py-0.5 text-xs text-gray-700">
                                {{ s.module }} ‚Äî {{ s.level|replace('_',' ')|title }}
                              </span>
                            {% endfor %}
                          </div>
                        {% else %}
                          <div class="text-sm text-gray-400 mb-3">‚Äî</div>
                        {% endif %}

                        <dl class="grid grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-2 text-sm">
                          <div>
                            <dt class="text-gray-500">Upcoming Sessions</dt>
                            <dd class="font-medium">{{ f.upcoming_sessions or '‚Äî' }}</dd>
                          </div>
                          <div>
                            <dt class="text-gray-500">Total Hours</dt>
                            <dd class="font-medium">{{ f.total_hours or '‚Äî' }}</dd>
                          </div>
                          <div>
                            <dt class="text-gray-500">Last Login</dt>
                            <dd class="font-medium">
                              {% if f.last_login %}{{ f.last_login.strftime("%-m/%-d/%Y") }}{% else %}‚Äî{% endif %}
                            </dd>
                          </div>
                        </dl>
                      </div>
                    </div>

                    <!-- Status row -->
                    <div class="mt-3 pt-3 border-t flex items-center justify-between gap-4">
                      <div class="flex flex-wrap items-center gap-3 text-sm">
                        <span class="inline-flex items-center gap-2">
                          {% if f.has_profile %}
                            <span class="material-icons text-green-600">task_alt</span> Account Setup
                          {% else %}
                            <span class="material-icons text-gray-500">radio_button_unchecked</span> Account Setup
                          {% endif %}
                        </span>
                        <span class="inline-flex items-center gap-2">
                          {% if f.has_availability %}
                            <span class="material-icons text-green-600">task_alt</span> Availability Set
                          {% else %}
                            <span class="material-icons text-amber-600">error_outline</span> Needs Availability
                          {% endif %}
                        </span>
                      </div>

                      <div class="flex items-center gap-2">
                        <a href="#" class="inline-flex items-center gap-1 px-3 py-1.5 border rounded-lg text-sm hover:bg-gray-50">
                          <span class="material-icons text-base">visibility</span> View Profile
                        </a>
                        {% if not f.is_ready %}
                          <button type="button" class="inline-flex items-center gap-1 px-3 py-1.5 border rounded-lg text-sm hover:bg-gray-50">
                            <span class="material-icons text-base">notifications_active</span> Remind Setup
                          </button>
                        {% endif %}
                      </div>
                    </div>
                  </article>
                {% endfor %}
              {% else %}
                <div class="text-sm text-gray-600">No facilitators linked to this unit yet.</div>
              {% endif %}
            </div>
          </section>

          <!-- Swap & Approvals -->
          <section id="panel-team" class="uc-panel" role="tabpanel" aria-labelledby="tab-team" hidden>
            <div class="flex items-center justify-between mb-4">
              <div>
                <h2 class="text-xl font-semibold">Session Swap Management</h2>
                <p class="text-gray-600 text-sm">Review and approve session swap requests from facilitators</p>
              </div>
              {% if approvals and approvals.pending %}
                <span class="uc-badge">{{ approvals.pending }} pending approvals</span>
              {% endif %}
            </div>

            <!-- summary stats row -->
            <div class="uc-stats">
              <div class="uc-stat">
                <div class="uc-stat__value uc-stat__value--orange">{{ approvals.pending or 0 }}</div>
                <div class="uc-stat__label">Pending Approval</div>
              </div>
              <div class="uc-stat">
                <div class="uc-stat__value uc-stat__value--green">{{ approvals.approved_this_week or 0 }}</div>
                <div class="uc-stat__label">Approved This Week</div>
              </div>
              <div class="uc-stat">
                <div class="uc-stat__value uc-stat__value--blue">{{ approvals.total or 0 }}</div>
                <div class="uc-stat__label">Total Requests</div>
              </div>
            </div>

            <!-- detailed approval queue -->
            <div class="mt-6">
              <header class="flex items-center gap-2 mb-3">
                <span class="material-icons text-gray-700">task_alt</span>
                <h3 class="font-semibold text-gray-900">Approval Queue</h3>
              </header>

              {% if pending_requests and pending_requests|length %}
                <div class="space-y-4">
                  {% for r in pending_requests %}
                    <article class="swap-card">
                      <header class="swap-card__hdr">
                        <div class="flex items-center gap-2">
                          <span class="material-icons text-rose-500">swap_horiz</span>
                          <h4 class="font-semibold">Pending Swap Request</h4>
                          <span class="swap-chip">
                            Submitted {{ r.created_at.strftime("%a %b %d, %I:%M %p") if r.created_at else "‚Äî" }}
                          </span>
                        </div>
                      </header>

                      <div class="swap-card__body">
                        <!-- Left: requester -->
                        <div class="swap-col">
                          <div class="swap-person">
                            <div class="swap-avatar">{{ (r.req_first or r.req_email|default(''))[:1] }}</div>
                            <div>
                              <div class="swap-name">
                                {{ (r.req_first ~ ' ' ~ r.req_last)|trim if r.req_first or r.req_last else r.req_email }}
                              </div>
                              <div class="swap-sub">Requester</div>
                            </div>
                          </div>

                          <div class="swap-side-title text-rose-600">Giving up</div>
                          <div class="swap-side-session">
                            <div class="title">{{ r.req_module or ("Session #" ~ r.req_sess_id) }}</div>
                            <div class="meta">
                              {% if r.req_start and r.req_end %}
                                {{ r.req_start.strftime("%A, %b %d") }} ‚Ä¢ {{ r.req_start.strftime("%H:%M") }}‚Äì{{ r.req_end.strftime("%H:%M") }}
                              {% else %} ‚Äî {% endif %}
                            </div>
                          </div>
                        </div>

                        <!-- Middle chevron -->
                        <div class="swap-arrow">
                          <span class="material-icons">chevron_right</span>
                        </div>

                        <!-- Right: target -->
                        <div class="swap-col">
                          <div class="swap-person">
                            <div class="swap-avatar">{{ (r.tgt_first or r.tgt_email|default(''))[:1] }}</div>
                            <div>
                              <div class="swap-name">
                                {{ (r.tgt_first ~ ' ' ~ r.tgt_last)|trim if r.tgt_first or r.tgt_last else r.tgt_email }}
                              </div>
                              <div class="swap-sub">Target</div>
                            </div>
                          </div>

                          <div class="swap-side-title text-emerald-700">Taking on</div>
                          <div class="swap-side-session">
                            <div class="title">{{ r.tgt_module or ("Session #" ~ r.tgt_sess_id) }}</div>
                            <div class="meta">
                              {% if r.tgt_start and r.tgt_end %}
                                {{ r.tgt_start.strftime("%A, %b %d") }} ‚Ä¢ {{ r.tgt_start.strftime("%H:%M") }}‚Äì{{ r.tgt_end.strftime("%H:%M") }}
                              {% else %} ‚Äî {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>

                      {% if r.reason %}
                        <div class="swap-reason">
                          <div class="font-semibold mb-1">Reason for swap</div>
                          <p class="text-gray-700">{{ r.reason }}</p>
                        </div>
                      {% endif %}

                      <footer class="swap-card__ftr">
                        <form method="POST" action="{{ url_for('unitcoordinator.reject_swap', swap_id=r.id, unit=current_unit.id) }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button type="submit" class="btn btn-reject">
                            <span class="material-icons text-base">close</span> Reject
                          </button>
                        </form>
                        <form method="POST" action="{{ url_for('unitcoordinator.approve_swap', swap_id=r.id, unit=current_unit.id) }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button type="submit" class="btn btn-approve">
                            <span class="material-icons text-base">check</span> Approve
                          </button>
                        </form>
                      </footer>
                    </article>

                  {% endfor %}
                </div>
              {% else %}
                <div class="uc-panel-empty">No pending swap requests.</div>
              {% endif %}
            </div>
          </section>

        </div>
      </div>
    {% endif %}
  </main>


  <!-- MODAL -->
  <div id="createUnitModal" class="modal-overlay hidden">
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="create-unit-title">
      <button class="modal-close" aria-label="Close">‚úï</button>

      <div class="modal-top">
        <div class="modal-title">
          <h1 id="create-unit-title">Create New Unit</h1>
          <p>Set up a new teaching unit with sessions and schedule</p>
        </div>
      </div>

      <div class="modal-steps">
        <div class="step active"><span>1</span> Unit Information</div>
        <div class="step"><span>2</span> Date Range</div>
        <div class="step"><span>3</span> Sessions</div>
        <div class="step"><span>4</span> Bulk Staffing</div>
        <div class="step"><span>5</span> Review</div>
      </div>

      <form method="POST" action="{{ url_for('unitcoordinator.create_unit') }}" class="modal-form" id="create-unit-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="unit_id" id="unit_id" value="">

        <!-- STEP 1 -->
        <section class="wizard-step" data-step="1">
          <h2>Unit Information</h2>
          <p class="subtext">Enter the basic details for your teaching unit</p>

          <div class="form-grid">
            <div class="form-group">
              <label>Unit Name *</label>
              <input type="text" name="unit_name" required placeholder="e.g. Engineering Design"/>
            </div>
            <div class="form-group">
              <label>Unit Code *</label>
              <input type="text" name="unit_code" required placeholder="e.g. GENG2000"/>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Semester *</label>
              <div class="select" data-name="semester">
                <button type="button" class="select-trigger" aria-haspopup="listbox" aria-expanded="false">
                  <span class="select-value">Semester 1</span>
                  <span class="material-icons select-caret" aria-hidden="true">expand_more</span>
                </button>
                <ul class="select-list" role="listbox">
                  <li class="option selected" role="option" aria-selected="true" data-value="Semester 1"><span>Semester 1</span><span class="material-icons check">check</span></li>
                  <li class="option" role="option" data-value="Semester 2"><span>Semester 2</span><span class="material-icons check">check</span></li>
                  <li class="option" role="option" data-value="Summer"><span>Summer</span><span class="material-icons check">check</span></li>
                  <li class="option" role="option" data-value="Winter"><span>Winter</span><span class="material-icons check">check</span></li>
                </ul>
                <input type="hidden" name="semester" value="Semester 1">
              </div>
            </div>

            <div class="form-group">
              <label>Year *</label>
              <input type="number" name="year" required value="2025"/>
            </div>
          </div>

          <div class="form-group">
            <label>Description (optional)</label>
            <textarea name="description" rows="3" placeholder="Brief description..."></textarea>
          </div>
        </section>

        <!-- STEP 2: Date Range (INLINE CALENDARS) -->
        <section class="wizard-step hidden" data-step="2" aria-labelledby="date-range-title">
          <h2 id="date-range-title">When does this unit run?</h2>
          <p class="subtext">Select the start and end dates for your unit</p>

          <div class="date-grid">
            <!-- Start Date -->
            <div class="date-card">
              <label for="start_date_input">Start Date *</label>
              <!-- Screen-reader-only form value for Flask -->
              <input
                type="text"
                id="start_date_input"
                name="start_date"
                required
                class="sr-only"
                aria-describedby="start-calendar-desc"
              />
              <!-- Inline calendar -->
              <div id="start_calendar" aria-label="Start date calendar" aria-describedby="start-calendar-desc"></div>
              <span id="start-calendar-desc" class="sr-only">Use the calendar to pick a start date.</span>
            </div>

            <!-- End Date -->
            <div class="date-card">
              <label for="end_date_input">End Date *</label>
              <!-- Screen-reader-only form value for Flask -->
              <input
                type="text"
                id="end_date_input"
                name="end_date"
                required
                class="sr-only"
                aria-describedby="end-calendar-desc"
              />
              <!-- Inline calendar -->
              <div id="end_calendar" aria-label="End date calendar" aria-describedby="end-calendar-desc"></div>
              <span id="end-calendar-desc" class="sr-only">Use the calendar to pick an end date.</span>
            </div>
          </div>

          <!-- Summary (appears after both dates picked) -->
          <div id="date-summary" class="summary-card hidden mt-4" aria-live="polite">
            <span class="material-icons summary-icon" aria-hidden="true">event</span>
            <span id="date-summary-text"></span>
          </div>
        </section>

        <!-- STEP 3: Sessions -->
        <section class="wizard-step hidden" data-step="3" aria-labelledby="sessions-setup-title">
          <!-- Upload CSV wrapper (now has an id so we can hide it after success) -->
          <div id="setup_wrap" class="setup-card">
            <div class="setup-card__header">
              <span class="material-icons">cloud_upload</span>
              <div>
                <h3 class="setup-card__title">Setup Required</h3>
                <p class="setup-card__hint">
                  Before creating sessions, upload your facilitators list (CSV with a single header: <code>facilitator_email</code>).
                </p>
              </div>
            </div>

            <div class="upload-row">
              <!-- Left: Download template -->
              <div class="upload-col">
                <div class="hint-title">CSV Template</div>
                <p class="hint-sub">Use this file for correct column names.</p>
                <a class="btn-outline w-full sm:w-auto"
                  href="{{ url_for('unitcoordinator.download_setup_csv_template') }}"
                  target="_blank" rel="noopener">
                  <span class="material-icons" style="font-size:18px">download</span>
                  Download Facilitators CSV Template
                </a>
              </div>

              <!-- Right: Upload CSV -->
              <div class="upload-col">
                <div class="hint-title">Upload CSV</div>
                <p class="hint-sub">CSV must include a single header: <code>facilitator_email</code>.</p>
                <div class="filepicker">
                  <input id="setup_csv" name="setup_csv" type="file" accept=".csv" class="filepicker-input" />
                  <label for="setup_csv" class="filepicker-btn">
                    <span class="material-icons">upload_file</span>
                    Choose File
                  </label>
                  <span id="file_name" class="filepicker-name" aria-live="polite">No file selected</span>
                </div>

                <!-- Status -->
                <div id="upload_status" class="upload-status hidden" role="status" aria-live="polite"></div>
              </div>
            </div>
          </div>

          <!-- NEW: Upload CAS CSV (auto create sessions) -->
          <div class="setup-card mt-4">
            <div class="setup-card__header">
              <span class="material-icons">upload_file</span>
              <div>
                <h3 class="setup-card__title">Upload CAS CSV</h3>
                <p class="setup-card__hint">
                  Uses headers: <code>activity_group_code</code>, <code>day_of_week</code>, <code>start_time</code>, <code>weeks</code>, <code>duration</code>, <code>location</code>. Others are ignored.
                </p>
              </div>
            </div>

            <div class="upload-row">
              <div class="upload-col">
                <div class="hint-title">Example</div>
                <pre class="hint-sub whitespace-pre-wrap text-xs bg-gray-50 p-2 rounded">
activity_group_code,day_of_week,start_time,weeks,duration,location
Tutorial A,Tuesday,09:00,1-12,120,EZONE 1.24
                </pre>
              </div>

              <div class="upload-col">
                <div class="hint-title">Upload CSV</div>
                <p class="hint-sub">We'll create sessions based on start time + duration. Venues will be linked automatically.</p>
                <div class="filepicker">
                  <input id="cas_csv" name="cas_csv" type="file" accept=".csv" class="filepicker-input" />
                  <label for="cas_csv" class="filepicker-btn">
                    <span class="material-icons">upload_file</span>
                    Choose File
                  </label>
                  <span id="cas_file_name" class="filepicker-name" aria-live="polite">No file selected</span>
                </div>

                <button type="button" id="uploadCasBtn" class="cal-btn primary mt-3">Upload CAS</button>

                <div id="cas_upload_status" class="upload-status hidden mt-2" role="status" aria-live="polite"></div>
              </div>
            </div>
          </div>



          <input type="hidden" name="setup_complete" id="setup_complete" value="false"/>

          <!-- STEP 3B: Calendar -->
          <div id="calendar_wrap" class="mt-4 hidden">
            <div class="cal-toolbar">
              <button type="button" class="cal-btn" id="prevWeek">‚Äπ Previous Week</button>
              <button type="button" class="cal-btn" id="nextWeek">Next Week ‚Ä∫</button>
              <button type="button" class="cal-btn" id="goToday">Today</button>

              <div class="cal-title">
                <div id="calWeekTitle" class="font-semibold"></div>
                <div id="calWeekRange" class="text-xs text-gray-500"></div>
              </div>

              <label class="ml-auto text-sm flex items-center gap-2">
                <input id="toggleHolidays" type="checkbox" class="cal-checkbox" />
                Show holidays
              </label>
            </div>


            <div id="calGrid" class="mt-2" aria-label="Session Schedule"></div>

            <!-- Right-side inspector -->
            <aside id="calInspector" class="cal-inspector hidden" aria-live="polite">
              <!-- Title bar -->
              <div class="insp-top">
                <div class="insp-top-left">
                  <span class="material-icons insp-top-icon" aria-hidden="true">edit</span>
                  <div>
                    <div class="insp-title">Edit Session</div>
                    <div id="inspSub" class="insp-sub">Tuesday ‚Ä¢ 10:30‚Äì14:00</div>
                  </div>
                </div>
                <div class="insp-top-actions">
                  <button type="button" id="inspCloseBtn" class="icon-btn" title="Close"><span class="material-icons">close</span></button>
                </div>
              </div>

              <!-- Blue card -->
              <div class="insp-card">
                <div class="insp-card__hdr">
                  <span class="material-icons" aria-hidden="true">event_note</span>
                  <span>Session Overview</span>
                </div>

                <dl class="insp-kv">
                  <div class="kv-row"><dt>Day:</dt>       <dd id="inspDay"></dd></div>
                  <div class="kv-row"><dt>Time:</dt>      <dd id="inspTime"></dd></div>
                  <div class="kv-row"><dt>Duration:</dt>  <dd id="inspDur"></dd></div>
                  <div class="kv-row"><dt>Date:</dt>      <dd id="inspDate"></dd></div>
                </dl>
              </div>

              <div class="cal-inspector__body">
                <!-- BASIC INFORMATION CARD -->
                <section class="insp-section">
                  <header class="insp-section__hdr">
                    <span class="material-icons">menu_book</span>
                    <h4>Basic Information</h4>
                  </header>

                  <!-- Session Name -->
                  <label class="insp-field">
                    <span class="insp-field__label">
                      <span class="material-icons">edit</span>
                      Session Name
                    </span>
                    <input id="inspName" class="cal-input cal-input--soft" placeholder="New Session" />
                  </label>
                </section>
                <!-- SESSION TIMING -->
                <section class="insp-section">
                  <header class="insp-section__hdr">
                    <span class="material-icons">schedule</span>
                    <h4>Session Timing</h4>
                  </header>

                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <label class="insp-field">
                      <span class="insp-field__label">
                        <span class="material-icons">access_time</span>
                        Start Time
                      </span>
                      <!-- we upgrade these to Flatpickr time pickers in JS -->
                      <input id="inspStartTime" class="cal-input cal-input--soft" placeholder="10:30 AM" />
                    </label>

                    <label class="insp-field">
                      <span class="insp-field__label">
                        <span class="material-icons">schedule</span>
                        End Time
                      </span>
                      <input id="inspEndTime" class="cal-input cal-input--soft" placeholder="01:15 PM" />
                    </label>
                  </div>

                  <div class="mt-2">
                    <div class="text-xs text-gray-500 mb-2">
                      Quick Presets
                    </div>
                    <div class="flex flex-wrap gap-2">
                      <button type="button" class="cal-btn insp-preset" data-range="09:00-12:00">09:00‚Äì12:00</button>
                      <button type="button" class="cal-btn insp-preset" data-range="13:00-16:00">13:00‚Äì16:00</button>
                      <button type="button" class="cal-btn insp-preset" data-range="09:00-17:00">09:00‚Äì17:00</button>
                    </div>
                  </div>
                </section>
                <!-- RECURRENCE -->
                <section class="insp-section">
                  <header class="insp-section__hdr">
                    <span class="material-icons">repeat</span>
                    <h4>Recurrence Pattern</h4>
                  </header>

                  <div class="space-y-3">

                    <!-- Occurs -->
                    <label class="insp-field">
                      <span class="insp-field__label">
                        <span class="material-icons">event_repeat</span>
                        Occurs
                      </span>
                      <select id="recOccurs" class="cal-input cal-input--soft">
                        <option value="none">Does not repeat</option>
                        <option value="weekly">Weekly</option>
                      </select>
                    </label>

                    <!-- Preview -->
                    <div id="recPreview" class="rounded-xl bg-purple-50 border border-purple-200 p-3 text-purple-900 hidden">
                      <div class="font-medium">Pattern: <span id="recPatternText"></span></div>
                      <div class="text-xs mt-1">
                        <div>First occurrence: <span id="recFirst"></span></div>
                        <div>Estimated total sessions: <span id="recTotal"></span></div>
                      </div>
                    </div>

                    <!-- Controls -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <label class="insp-field">
                        <span class="insp-field__label">
                          <span class="material-icons">format_list_numbered</span>
                          Number of Sessions
                        </span>
                        <input id="recCount" type="number" min="1" class="cal-input cal-input--soft" value="12" />
                      </label>

                      <label class="insp-field">
                        <span class="insp-field__label">
                          <span class="material-icons">event</span>
                          End Date (Optional)
                        </span>
                        <input id="recUntil" type="text" class="cal-input cal-input--soft" placeholder="dd/mm/yyyy" />
                      </label>
                    </div>
                    <p class="text-xs text-gray-500">
                      Sessions will repeat weekly until the number of sessions is reached or the end date (if set), whichever comes first.
                    </p>
                  </div>
                </section>

                <!-- STAFFING REQUIREMENTS -->
                <section class="insp-section">
                  <header class="insp-section__hdr">
                    <span class="material-icons">group</span>
                    <h4>Staffing Requirements</h4>
                  </header>

                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <label class="insp-field">
                      <span class="insp-field__label">
                        <span class="material-icons">person</span>
                        Lead Staff Required
                      </span>
                      <input id="inspLeadStaff" type="number" min="0" class="cal-input cal-input--soft" value="1" />
                    </label>

                    <label class="insp-field">
                      <span class="insp-field__label">
                        <span class="material-icons">group_add</span>
                        Support Staff Required
                      </span>
                      <input id="inspSupportStaff" type="number" min="0" class="cal-input cal-input--soft" value="0" />
                    </label>
                  </div>
                </section>

              </div>
              <div class="cal-inspector__footer">
                <button type="button" id="inspDelete" class="cal-btn danger hidden">Delete</button>
                <button type="button" id="inspCancel" class="cal-btn">Cancel</button>
                <button type="button" id="inspSave" class="cal-btn primary">Save</button>
              </div>
            </aside>

          </div>
        </section>

        <!-- STEP 4: Bulk Staffing -->
        <section class="wizard-step hidden" data-step="4" aria-labelledby="bulk-staffing-title">
          <h2 id="bulk-staffing-title">Bulk Staffing</h2>
          <p class="subtext">Set staff requirements across multiple sessions</p>

          <div class="bg-white border border-gray-200 rounded-xl p-6">
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-2">Set Staff Requirements</h3>
              <p class="text-gray-600 text-sm">
                Use bulk staffing to quickly set lead and support staff requirements across multiple sessions. 
                This step is optional - you can adjust individual session staffing later.
              </p>
            </div>

            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
              <h4 class="font-semibold mb-4">Bulk staffing</h4>
              
              <!-- Filter Options -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Choose what you want to update in bulk:</label>
                <div class="space-y-3">
                  <label class="flex items-center">
                    <input type="radio" name="bulk_filter_type" value="activity" class="mr-3" checked>
                    <span>By activity</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="bulk_filter_type" value="session_name" class="mr-3">
                    <span>By session name</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="bulk_filter_type" value="module" class="mr-3">
                    <span>By module</span>
                  </label>
                </div>
              </div>

              <!-- Filter Selection -->
              <div class="mb-6">
                <label for="bulk_filter_select" class="block text-sm font-medium text-gray-700 mb-2">Select activity</label>
                <select id="bulk_filter_select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Choose an option...</option>
                </select>
              </div>

              <!-- Staff Requirements -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Lead</label>
                  <div class="flex items-center space-x-2">
                    <button type="button" id="lead_decrease" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">-</button>
                    <input type="number" id="lead_count" value="1" min="0" class="w-16 text-center border border-gray-300 rounded-md px-2 py-1">
                    <button type="button" id="lead_increase" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">+</button>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Support</label>
                  <div class="flex items-center space-x-2">
                    <button type="button" id="support_decrease" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">-</button>
                    <input type="number" id="support_count" value="0" min="0" class="w-16 text-center border border-gray-300 rounded-md px-2 py-1">
                    <button type="button" id="support_increase" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">+</button>
                  </div>
                </div>
              </div>

              <!-- Options -->
              <div class="mb-6">
                <label class="flex items-center">
                  <input type="checkbox" id="respect_overrides" checked class="mr-2">
                  <span class="text-sm text-gray-700">Respect overrides</span>
                </label>
              </div>

              <!-- Filters Toggle -->
              <div class="mb-6">
                <button type="button" id="show_filters" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                  <span>Show filters</span>
                  <span class="ml-1">‚ñº</span>
                </button>
              </div>

              <!-- Action Buttons -->
              <div class="flex space-x-3">
                <button type="button" id="preview_bulk" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 flex items-center">
                  <span class="material-icons mr-2" style="font-size: 18px;">visibility</span>
                  Preview
                </button>
                <button type="button" id="apply_bulk" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900 flex items-center">
                  <span class="material-icons mr-2" style="font-size: 18px;">check</span>
                  Apply to all
                </button>
                <button type="button" id="reset_bulk" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center">
                  <span class="material-icons mr-2" style="font-size: 18px;">refresh</span>
                  Reset to 0
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- STEP 5: Review -->
        <section class="wizard-step hidden" data-step="5" aria-labelledby="review-title">
          <h2 id="review-title">Review &amp; Create</h2>
          <p class="subtext">Confirm details before creating your unit</p>

          <div class="bg-white border border-gray-200 rounded-xl p-5 space-y-6">
            <!-- Unit Details -->
            <div>
              <h3 class="text-base font-semibold mb-3">Unit Details</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <dl class="space-y-2">
                  <div class="flex justify-between">
                    <dt class="text-gray-500">Name:</dt><dd id="rv_name" class="font-medium">‚Äî</dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-gray-500">Code:</dt><dd id="rv_code" class="font-medium">‚Äî</dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-gray-500">Semester:</dt><dd id="rv_sem" class="font-medium">‚Äî</dd>
                  </div>
                </dl>
                <dl class="space-y-2">
                  <div class="flex justify-between">
                    <dt class="text-gray-500">Start Date:</dt><dd id="rv_start" class="font-medium">‚Äî</dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-gray-500">End Date:</dt><dd id="rv_end" class="font-medium">‚Äî</dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-gray-500">Duration:</dt><dd id="rv_weeks" class="font-medium">‚Äî</dd>
                  </div>
                </dl>
              </div>
            </div>

            <!-- Sessions -->
            <div>
              <h3 class="text-base font-semibold mb-3">Sessions (<span id="rv_sess_count">0</span>)</h3>
              <ul id="rv_sessions" class="space-y-2"></ul>
            </div>

          </div>
        </section>

      </form>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" onclick="prevStep()">‚Üê Back</button>
        <button type="button" class="btn-primary" id="next-btn" onclick="nextStep()">Next ‚Üí</button>

        <!-- submit still links to the form via id -->
        <button type="submit" class="btn-primary hidden" id="submit-btn" form="create-unit-form">
          Create Unit
        </button>
      </div>
    </div>
  </div>

<script>
  window.FLASK_ROUTES = {
    CAL_WEEK_TEMPLATE: "{{ url_for('unitcoordinator.calendar_week',  unit_id=0) }}",
    CREATE_SESS_TEMPLATE: "{{ url_for('unitcoordinator.create_session', unit_id=0) }}",
    UPDATE_SESS_TEMPLATE: "{{ url_for('unitcoordinator.update_session', session_id=0) }}",
    DELETE_SESS_TEMPLATE: "{{ url_for('unitcoordinator.delete_session', session_id=0) }}",
    CREATE_OR_GET_DRAFT: "{{ url_for('unitcoordinator.create_or_get_draft') }}",
    UPLOAD_SETUP_CSV: "{{ url_for('unitcoordinator.upload_setup_csv') }}",
    UPLOAD_SESSIONS_TEMPLATE: "{{ url_for('unitcoordinator.upload_sessions_csv', unit_id=0) }}",
    LIST_FACILITATORS_TEMPLATE: "{{ url_for('unitcoordinator.list_facilitators', unit_id=0) }}",
    UPLOAD_CAS_TEMPLATE: "{{ url_for('unitcoordinator.upload_cas_csv', unit_id=0) }}"
  };
  window.CSRF_TOKEN = "{{ csrf_token() }}";

  // Profile dropdown functionality
  function openProfilePage() {
    window.location.href = '/unitcoordinator/profile';
  }
  
  function openAccountSettings() {
    alert('Account settings coming soon!');
    // window.location.href = '/unitcoordinator/settings';
  }
  
  function openPreferences() {
    alert('Preferences coming soon!');
    // window.location.href = '/unitcoordinator/preferences';
  }
  
  function openNotifications() {
    alert('Notification settings coming soon!');
    // window.location.href = '/unitcoordinator/notifications';
  }
  
  function openHelp() {
    alert('Help & Support coming soon!');
    // window.location.href = '/help';
  }
  
  function openAbout() {
    alert('About Unit Coordinator Portal\nVersion 1.0.0\nBuilt with Flask & Python');
    // window.location.href = '/about';
  }
  
  function confirmLogout() {
    if (confirm('Are you sure you want to sign out?')) {
      // Use the existing logout form
      const logoutForm = document.querySelector('.logout-form');
      if (logoutForm) {
        logoutForm.submit();
      } else {
        window.location.href = '/auth/logout';
      }
    }
  }
</script>


<!-- External JS -->
<script src="{{ url_for('static', filename='js/uc.js') }}"></script>



</body>
</html>
